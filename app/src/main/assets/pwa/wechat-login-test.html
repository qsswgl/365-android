<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¾®ä¿¡ç™»å½•æµ‹è¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 24px;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            font-size: 14px;
            margin-bottom: 30px;
        }
        
        .wechat-info {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .wechat-info h3 {
            color: #0369a1;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .wechat-info p {
            color: #0c4a6e;
            font-size: 12px;
            line-height: 1.6;
            margin: 5px 0;
        }
        
        .wechat-info code {
            background: #e0f2fe;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
        }
        
        .btn {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
        }
        
        .btn-wechat {
            background: #07c160;
            color: white;
        }
        
        .btn-wechat:hover {
            background: #06ad56;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(7, 193, 96, 0.3);
        }
        
        .btn-wechat:active {
            transform: translateY(0);
        }
        
        .btn-clear {
            background: #f1f5f9;
            color: #64748b;
        }
        
        .btn-clear:hover {
            background: #e2e8f0;
        }
        
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            font-size: 14px;
            line-height: 1.6;
            display: none;
        }
        
        .result.success {
            background: #d1fae5;
            border: 1px solid #10b981;
            color: #065f46;
            display: block;
        }
        
        .result.error {
            background: #fee2e2;
            border: 1px solid #ef4444;
            color: #991b1b;
            display: block;
        }
        
        .result h3 {
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .result pre {
            background: rgba(0,0,0,0.05);
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .log {
            margin-top: 20px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .log h3 {
            color: #334155;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .log-item {
            font-size: 12px;
            padding: 5px 0;
            border-bottom: 1px solid #e2e8f0;
            color: #475569;
        }
        
        .log-item:last-child {
            border-bottom: none;
        }
        
        .log-time {
            color: #94a3b8;
            margin-right: 5px;
        }
        
        .icon {
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-right: 5px;
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” å¾®ä¿¡ç™»å½•æµ‹è¯•</h1>
        <p class="subtitle">365é…’æ°´ - JSBridgeå¾®ä¿¡ç™»å½•åŠŸèƒ½æµ‹è¯•</p>
        
        <div class="wechat-info">
            <h3>ğŸ“± å¾®ä¿¡å¼€æ”¾å¹³å°ä¿¡æ¯</h3>
            <p>åº”ç”¨åç§°ï¼š<code>365é…’æ°´</code></p>
            <p>APPIDï¼š<code>wx19d89333ff0d3efe</code></p>
            <p>åŠŸèƒ½ï¼šé€šè¿‡JSBridgeè°ƒç”¨å¾®ä¿¡ç™»å½•ï¼Œè·å–æˆæƒcode</p>
        </div>
        
        <button class="btn btn-wechat" onclick="startWeChatLogin()">
            <span class="icon">ğŸ’š</span>
            å¾®ä¿¡ç™»å½•
        </button>
        
        <button class="btn btn-wechat" onclick="getUserInfo()" id="getUserInfoBtn" style="display: none;">
            <span class="icon">ğŸ‘¤</span>
            è·å–å¾®ä¿¡ä¿¡æ¯
        </button>
        
        <button class="btn btn-clear" onclick="clearResult()">
            ğŸ—‘ï¸ æ¸…ç©ºç»“æœ
        </button>
        
        <div id="result" class="result"></div>
        
        <div class="log">
            <h3>ğŸ“‹ æ“ä½œæ—¥å¿—</h3>
            <div id="logContainer"></div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡ä¿å­˜å¾®ä¿¡ç™»å½•code
        let wechatCode = null;
        let wechatState = null;
        
        // æ·»åŠ æ—¥å¿—
        function addLog(message) {
            const logContainer = document.getElementById('logContainer');
            const time = new Date().toLocaleTimeString('zh-CN', { hour12: false });
            const logItem = document.createElement('div');
            logItem.className = 'log-item';
            logItem.innerHTML = `<span class="log-time">${time}</span>${message}`;
            logContainer.appendChild(logItem);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // æ˜¾ç¤ºç»“æœ
        function showResult(success, title, content) {
            const resultDiv = document.getElementById('result');
            resultDiv.className = success ? 'result success' : 'result error';
            resultDiv.innerHTML = `
                <h3>${success ? 'âœ…' : 'âŒ'} ${title}</h3>
                <pre>${content}</pre>
            `;
        }
        
        // æ¸…ç©ºç»“æœ
        function clearResult() {
            document.getElementById('result').style.display = 'none';
            document.getElementById('logContainer').innerHTML = '';
            addLog('æ¸…ç©ºäº†ç»“æœå’Œæ—¥å¿—');
        }
        
        // å¾®ä¿¡ç™»å½•æˆåŠŸå›è°ƒ
        function onWeChatLoginSuccess(result) {
            console.log('[å¾®ä¿¡ç™»å½•] æˆåŠŸå›è°ƒ:', result);
            addLog('âœ… å¾®ä¿¡ç™»å½•æˆåŠŸ');
            
            // ä¿å­˜codeå’Œstate
            wechatCode = result.code;
            wechatState = result.state;
            
            const content = `æˆæƒç  (code): ${result.code}
çŠ¶æ€ (state): ${result.state}

ä¸‹ä¸€æ­¥ï¼š
1. å°† code å‘é€åˆ°æœåŠ¡å™¨
2. æœåŠ¡å™¨ä½¿ç”¨ code + AppSecret æ¢å– access_token
3. ä½¿ç”¨ access_token è·å–ç”¨æˆ·ä¿¡æ¯

å®Œæ•´å“åº”:
${JSON.stringify(result, null, 2)}`;
            
            showResult(true, 'å¾®ä¿¡ç™»å½•æˆåŠŸ', content);
            
            // æ˜¾ç¤º"è·å–å¾®ä¿¡ä¿¡æ¯"æŒ‰é’®
            document.getElementById('getUserInfoBtn').style.display = 'block';
        }
        
        // å¾®ä¿¡ç™»å½•å¤±è´¥å›è°ƒ
        function onWeChatLoginError(result) {
            console.error('[å¾®ä¿¡ç™»å½•] å¤±è´¥å›è°ƒ:', result);
            
            let message = '';
            switch(result.error) {
                case 'CANCEL':
                    message = 'ç”¨æˆ·å–æ¶ˆäº†ç™»å½•';
                    addLog('âš ï¸ ç”¨æˆ·å–æ¶ˆäº†å¾®ä¿¡ç™»å½•');
                    break;
                case 'DENIED':
                    message = 'ç”¨æˆ·æ‹’ç»äº†æˆæƒ';
                    addLog('âŒ ç”¨æˆ·æ‹’ç»äº†å¾®ä¿¡æˆæƒ');
                    break;
                case 'NOT_INSTALLED':
                    message = 'æœªå®‰è£…å¾®ä¿¡å®¢æˆ·ç«¯';
                    addLog('âŒ è®¾å¤‡æœªå®‰è£…å¾®ä¿¡');
                    break;
                case 'VERSION_TOO_LOW':
                    message = 'å¾®ä¿¡ç‰ˆæœ¬è¿‡ä½';
                    addLog('âŒ å¾®ä¿¡ç‰ˆæœ¬è¿‡ä½');
                    break;
                default:
                    message = result.message || 'æœªçŸ¥é”™è¯¯';
                    addLog('âŒ å¾®ä¿¡ç™»å½•å¤±è´¥: ' + message);
            }
            
            const content = `é”™è¯¯ç±»å‹: ${result.error}
é”™è¯¯ä¿¡æ¯: ${message}

å®Œæ•´å“åº”:
${JSON.stringify(result, null, 2)}`;
            
            showResult(false, 'å¾®ä¿¡ç™»å½•å¤±è´¥', content);
        }
        
        // å¯åŠ¨å¾®ä¿¡ç™»å½•
        function startWeChatLogin() {
            addLog('ğŸš€ å¼€å§‹å¾®ä¿¡ç™»å½•...');
            
            try {
                // æ£€æŸ¥AndroidBridgeæ˜¯å¦å­˜åœ¨
                if (typeof AndroidBridge === 'undefined') {
                    addLog('âŒ AndroidBridgeä¸å­˜åœ¨ï¼ˆå¯èƒ½ä¸åœ¨APPä¸­ï¼‰');
                    showResult(false, 'AndroidBridgeä¸å­˜åœ¨', 
                        'æ­¤åŠŸèƒ½ä»…åœ¨365é…’æ°´APPä¸­å¯ç”¨ã€‚\nè¯·åœ¨APPçš„WebViewä¸­æ‰“å¼€æ­¤é¡µé¢ã€‚');
                    return;
                }
                
                // æ£€æŸ¥å¾®ä¿¡ç™»å½•æ–¹æ³•æ˜¯å¦å­˜åœ¨
                if (typeof AndroidBridge.weChatLogin !== 'function') {
                    addLog('âŒ weChatLoginæ–¹æ³•ä¸å­˜åœ¨');
                    showResult(false, 'æ–¹æ³•ä¸å­˜åœ¨', 
                        'AndroidBridge.weChatLogin æ–¹æ³•ä¸å­˜åœ¨ã€‚\nè¯·ç¡®ä¿APPå·²æ­£ç¡®å®ç°å¾®ä¿¡ç™»å½•åŠŸèƒ½ã€‚');
                    return;
                }
                
                addLog('ğŸ“± è°ƒç”¨ AndroidBridge.weChatLogin()');
                addLog('â³ ç­‰å¾…å¾®ä¿¡å®¢æˆ·ç«¯å“åº”...');
                
                // è°ƒç”¨AndroidBridgeçš„å¾®ä¿¡ç™»å½•æ–¹æ³•
                // æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨å­—ç¬¦ä¸²å½¢å¼çš„å›è°ƒå‡½æ•°å
                AndroidBridge.weChatLogin('handleWeChatLoginResult');
                
            } catch (e) {
                console.error('[å¾®ä¿¡ç™»å½•] å¼‚å¸¸:', e);
                addLog('âŒ è°ƒç”¨å¤±è´¥: ' + e.message);
                showResult(false, 'è°ƒç”¨å¼‚å¸¸', e.message);
            }
        }
        
        // å¤„ç†å¾®ä¿¡ç™»å½•ç»“æœï¼ˆç”±Androidå›è°ƒï¼‰
        function handleWeChatLoginResult(result) {
            console.log('[å¾®ä¿¡ç™»å½•] æ”¶åˆ°å›è°ƒ:', result);
            
            if (result.error) {
                // ç™»å½•å¤±è´¥
                onWeChatLoginError(result);
            } else if (result.code) {
                // ç™»å½•æˆåŠŸ
                onWeChatLoginSuccess(result);
            } else {
                // æœªçŸ¥å“åº”
                addLog('âš ï¸ æ”¶åˆ°æœªçŸ¥å“åº”');
                showResult(false, 'æœªçŸ¥å“åº”', JSON.stringify(result, null, 2));
            }
        }
        
        // è·å–å¾®ä¿¡ç”¨æˆ·ä¿¡æ¯
        async function getUserInfo() {
            if (!wechatCode) {
                alert('è¯·å…ˆè¿›è¡Œå¾®ä¿¡ç™»å½•è·å–code');
                return;
            }
            
            addLog('ğŸ”„ å¼€å§‹è·å–å¾®ä¿¡ç”¨æˆ·ä¿¡æ¯...');
            addLog('ğŸ“¤ è°ƒç”¨æœåŠ¡å™¨API');
            
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                showResult(true, 'æ­£åœ¨è·å–ç”¨æˆ·ä¿¡æ¯...', 'è¯·ç¨å€™...');
                
                // è°ƒç”¨æœåŠ¡å™¨API
                const response = await fetch('https://oauth.qsgl.net/api/Wechat/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        code: wechatCode
                    })
                });
                
                addLog(`ğŸ“¥ æœåŠ¡å™¨å“åº”: ${response.status} ${response.statusText}`);
                
                if (!response.ok) {
                    // å¤„ç†é”™è¯¯å“åº”
                    const errorText = await response.text();
                    addLog(`âŒ è¯·æ±‚å¤±è´¥: ${errorText}`);
                    
                    let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMessage = errorJson.detail || errorJson.title || errorMessage;
                    } catch (e) {
                        errorMessage = errorText || errorMessage;
                    }
                    
                    showResult(false, 'è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥', errorMessage);
                    return;
                }
                
                // è§£ææˆåŠŸå“åº”
                const userData = await response.json();
                console.log('[ç”¨æˆ·ä¿¡æ¯]:', userData);
                addLog('âœ… æˆåŠŸè·å–ç”¨æˆ·ä¿¡æ¯');
                
                // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
                const userInfoHtml = `å¾®ä¿¡ç”¨æˆ·ä¿¡æ¯ï¼š

UnionID: ${userData.unionid || 'æœªè·å–'}
OpenID: ${userData.openid || 'æœªè·å–'}
æ˜µç§°: ${userData.nickname || 'æœªè®¾ç½®'}
æ€§åˆ«: ${userData.sex === 1 ? 'ç”·' : userData.sex === 2 ? 'å¥³' : 'æœªçŸ¥'}
å›½å®¶: ${userData.country || 'æœªçŸ¥'}
çœä»½: ${userData.province || 'æœªçŸ¥'}
åŸå¸‚: ${userData.city || 'æœªçŸ¥'}
å¤´åƒURL: ${userData.headImgUrl || 'æ— '}

å®Œæ•´æ•°æ®:
${JSON.stringify(userData, null, 2)}`;
                
                showResult(true, 'âœ… å¾®ä¿¡ç”¨æˆ·ä¿¡æ¯è·å–æˆåŠŸ', userInfoHtml);
                
                // å¦‚æœæœ‰å¤´åƒï¼Œå¯ä»¥æ˜¾ç¤º
                if (userData.headImgUrl) {
                    addLog('ğŸ‘¤ ç”¨æˆ·å¤´åƒ: ' + userData.headImgUrl);
                }
                
            } catch (error) {
                console.error('[è·å–ç”¨æˆ·ä¿¡æ¯] å¼‚å¸¸:', error);
                addLog('âŒ è·å–ç”¨æˆ·ä¿¡æ¯å¼‚å¸¸: ' + error.message);
                showResult(false, 'è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥', `é”™è¯¯: ${error.message}\n\nè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒæœåŠ¡å™¨çŠ¶æ€`);
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆ
        window.onload = function() {
            addLog('ğŸ“„ é¡µé¢åŠ è½½å®Œæˆ');
            addLog('ğŸ” æ£€æµ‹è¿è¡Œç¯å¢ƒ...');
            
            if (typeof AndroidBridge !== 'undefined') {
                addLog('âœ… æ£€æµ‹åˆ° AndroidBridge');
                addLog('âœ… è¿è¡Œåœ¨365é…’æ°´APPä¸­');
                
                if (typeof AndroidBridge.weChatLogin === 'function') {
                    addLog('âœ… å¾®ä¿¡ç™»å½•åŠŸèƒ½å¯ç”¨');
                } else {
                    addLog('âš ï¸ å¾®ä¿¡ç™»å½•åŠŸèƒ½ä¸å¯ç”¨');
                }
            } else {
                addLog('âš ï¸ æœªæ£€æµ‹åˆ° AndroidBridge');
                addLog('âš ï¸ è¯·åœ¨365é…’æ°´APPä¸­æ‰“å¼€');
            }
        };
    </script>
</body>
</html>

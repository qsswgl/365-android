<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¾®ä¿¡ç™»å½•æµ‹è¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 24px;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            font-size: 14px;
            margin-bottom: 30px;
        }
        
        .wechat-info {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .wechat-info h3 {
            color: #0369a1;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .wechat-info p {
            color: #0c4a6e;
            font-size: 12px;
            line-height: 1.6;
            margin: 5px 0;
        }
        
        .wechat-info code {
            background: #e0f2fe;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
        }
        
        .btn {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
        }
        
        .btn-wechat {
            background: #07c160;
            color: white;
        }
        
        .btn-wechat:hover {
            background: #06ad56;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(7, 193, 96, 0.3);
        }
        
        .btn-wechat:active {
            transform: translateY(0);
        }
        
        .btn-clear {
            background: #f1f5f9;
            color: #64748b;
        }
        
        .btn-clear:hover {
            background: #e2e8f0;
        }
        
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            font-size: 14px;
            line-height: 1.6;
            display: none;
        }
        
        .result.success {
            background: #d1fae5;
            border: 1px solid #10b981;
            color: #065f46;
            display: block;
        }
        
        .result.error {
            background: #fee2e2;
            border: 1px solid #ef4444;
            color: #991b1b;
            display: block;
        }
        
        .result h3 {
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .result pre {
            background: rgba(0,0,0,0.05);
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .log {
            margin-top: 20px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .log h3 {
            color: #334155;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .log-item {
            font-size: 12px;
            padding: 5px 0;
            border-bottom: 1px solid #e2e8f0;
            color: #475569;
        }
        
        .log-item:last-child {
            border-bottom: none;
        }
        
        .log-time {
            color: #94a3b8;
            margin-right: 5px;
        }
        
        .icon {
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-right: 5px;
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” å¾®ä¿¡åŠŸèƒ½æµ‹è¯•</h1>
        <p class="subtitle">365é…’æ°´ - å¾®ä¿¡ç™»å½•/æ”¯ä»˜/å°ç¨‹åºåŠŸèƒ½æµ‹è¯•</p>
        
        <div class="wechat-info">
            <h3>ğŸ“± å¾®ä¿¡å¼€æ”¾å¹³å°ä¿¡æ¯</h3>
            <p>åº”ç”¨åç§°ï¼š<code>365é…’æ°´</code></p>
            <p>ç§»åŠ¨åº”ç”¨APPIDï¼š<code>wx19d89333ff0d3efe</code></p>
            <p>å°ç¨‹åºAPPIDï¼š<code>wxeccdc65a2acea494</code></p>
            <p>åŠŸèƒ½ï¼šå¾®ä¿¡ç™»å½•ã€å¾®ä¿¡æ”¯ä»˜ã€æ‹‰èµ·å°ç¨‹åº</p>
        </div>
        
        <button class="btn btn-wechat" onclick="startWeChatLogin()">
            <span class="icon">ğŸ’š</span>
            å¾®ä¿¡ç™»å½•
        </button>
        
        <button class="btn btn-wechat" onclick="getUserInfo()" id="getUserInfoBtn" style="display: none;">
            <span class="icon">ğŸ‘¤</span>
            è·å–å¾®ä¿¡ä¿¡æ¯
        </button>
        
        <button class="btn btn-wechat" onclick="startWeChatPay()" style="background: #ff6b00;">
            <span class="icon">ğŸ’°</span>
            å¾®ä¿¡æ”¯ä»˜æµ‹è¯•
        </button>
        
        <button class="btn btn-wechat" onclick="launchMiniProgram()" style="background: #07c160;">
            <span class="icon">ğŸš€</span>
            æ‹‰èµ·å¾®ä¿¡å°ç¨‹åº
        </button>
        
        <button class="btn btn-wechat" onclick="startAlipayPayment()" style="background: #1677FF;">
            <span class="icon">ğŸ’™</span>
            æ”¯ä»˜å®æ”¯ä»˜
        </button>
        
        <button class="btn btn-clear" onclick="clearResult()">
            ğŸ—‘ï¸ æ¸…ç©ºç»“æœ
        </button>
        
        <div id="result" class="result"></div>
        
        <div class="log">
            <h3>ğŸ“‹ æ“ä½œæ—¥å¿—</h3>
            <div id="logContainer"></div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡ä¿å­˜å¾®ä¿¡ç™»å½•code
        let wechatCode = null;
        let wechatState = null;
        
        // æ·»åŠ æ—¥å¿—
        function addLog(message) {
            const logContainer = document.getElementById('logContainer');
            const time = new Date().toLocaleTimeString('zh-CN', { hour12: false });
            const logItem = document.createElement('div');
            logItem.className = 'log-item';
            logItem.innerHTML = `<span class="log-time">${time}</span>${message}`;
            logContainer.appendChild(logItem);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // æ˜¾ç¤ºç»“æœ
        function showResult(success, title, content) {
            const resultDiv = document.getElementById('result');
            resultDiv.className = success ? 'result success' : 'result error';
            resultDiv.innerHTML = `
                <h3>${success ? 'âœ…' : 'âŒ'} ${title}</h3>
                <pre>${content}</pre>
            `;
        }
        
        // æ¸…ç©ºç»“æœ
        function clearResult() {
            document.getElementById('result').style.display = 'none';
            document.getElementById('logContainer').innerHTML = '';
            addLog('æ¸…ç©ºäº†ç»“æœå’Œæ—¥å¿—');
        }
        
        // å¾®ä¿¡ç™»å½•æˆåŠŸå›è°ƒ
        function onWeChatLoginSuccess(result) {
            console.log('[å¾®ä¿¡ç™»å½•] æˆåŠŸå›è°ƒ:', result);
            addLog('âœ… å¾®ä¿¡ç™»å½•æˆåŠŸ');
            
            // ä¿å­˜codeå’Œstate
            wechatCode = result.code;
            wechatState = result.state;
            
            const content = `æˆæƒç  (code): ${result.code}
çŠ¶æ€ (state): ${result.state}

ä¸‹ä¸€æ­¥ï¼š
1. å°† code å‘é€åˆ°æœåŠ¡å™¨
2. æœåŠ¡å™¨ä½¿ç”¨ code + AppSecret æ¢å– access_token
3. ä½¿ç”¨ access_token è·å–ç”¨æˆ·ä¿¡æ¯

å®Œæ•´å“åº”:
${JSON.stringify(result, null, 2)}`;
            
            showResult(true, 'å¾®ä¿¡ç™»å½•æˆåŠŸ', content);
            
            // æ˜¾ç¤º"è·å–å¾®ä¿¡ä¿¡æ¯"æŒ‰é’®
            document.getElementById('getUserInfoBtn').style.display = 'block';
        }
        
        // å¾®ä¿¡ç™»å½•å¤±è´¥å›è°ƒ
        function onWeChatLoginError(result) {
            console.error('[å¾®ä¿¡ç™»å½•] å¤±è´¥å›è°ƒ:', result);
            
            let message = '';
            switch(result.error) {
                case 'CANCEL':
                    message = 'ç”¨æˆ·å–æ¶ˆäº†ç™»å½•';
                    addLog('âš ï¸ ç”¨æˆ·å–æ¶ˆäº†å¾®ä¿¡ç™»å½•');
                    break;
                case 'DENIED':
                    message = 'ç”¨æˆ·æ‹’ç»äº†æˆæƒ';
                    addLog('âŒ ç”¨æˆ·æ‹’ç»äº†å¾®ä¿¡æˆæƒ');
                    break;
                case 'NOT_INSTALLED':
                    message = 'æœªå®‰è£…å¾®ä¿¡å®¢æˆ·ç«¯';
                    addLog('âŒ è®¾å¤‡æœªå®‰è£…å¾®ä¿¡');
                    break;
                case 'VERSION_TOO_LOW':
                    message = 'å¾®ä¿¡ç‰ˆæœ¬è¿‡ä½';
                    addLog('âŒ å¾®ä¿¡ç‰ˆæœ¬è¿‡ä½');
                    break;
                default:
                    message = result.message || 'æœªçŸ¥é”™è¯¯';
                    addLog('âŒ å¾®ä¿¡ç™»å½•å¤±è´¥: ' + message);
            }
            
            const content = `é”™è¯¯ç±»å‹: ${result.error}
é”™è¯¯ä¿¡æ¯: ${message}

å®Œæ•´å“åº”:
${JSON.stringify(result, null, 2)}`;
            
            showResult(false, 'å¾®ä¿¡ç™»å½•å¤±è´¥', content);
        }
        
        // å¯åŠ¨å¾®ä¿¡ç™»å½•
        function startWeChatLogin() {
            addLog('ğŸš€ å¼€å§‹å¾®ä¿¡ç™»å½•...');
            
            try {
                // æ£€æŸ¥AndroidBridgeæ˜¯å¦å­˜åœ¨
                if (typeof AndroidBridge === 'undefined') {
                    addLog('âŒ AndroidBridgeä¸å­˜åœ¨ï¼ˆå¯èƒ½ä¸åœ¨APPä¸­ï¼‰');
                    showResult(false, 'AndroidBridgeä¸å­˜åœ¨', 
                        'æ­¤åŠŸèƒ½ä»…åœ¨365é…’æ°´APPä¸­å¯ç”¨ã€‚\nè¯·åœ¨APPçš„WebViewä¸­æ‰“å¼€æ­¤é¡µé¢ã€‚');
                    return;
                }
                
                // æ£€æŸ¥å¾®ä¿¡ç™»å½•æ–¹æ³•æ˜¯å¦å­˜åœ¨
                if (typeof AndroidBridge.weChatLogin !== 'function') {
                    addLog('âŒ weChatLoginæ–¹æ³•ä¸å­˜åœ¨');
                    showResult(false, 'æ–¹æ³•ä¸å­˜åœ¨', 
                        'AndroidBridge.weChatLogin æ–¹æ³•ä¸å­˜åœ¨ã€‚\nè¯·ç¡®ä¿APPå·²æ­£ç¡®å®ç°å¾®ä¿¡ç™»å½•åŠŸèƒ½ã€‚');
                    return;
                }
                
                addLog('ğŸ“± è°ƒç”¨ AndroidBridge.weChatLogin()');
                addLog('â³ ç­‰å¾…å¾®ä¿¡å®¢æˆ·ç«¯å“åº”...');
                
                // è°ƒç”¨AndroidBridgeçš„å¾®ä¿¡ç™»å½•æ–¹æ³•
                // æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨å­—ç¬¦ä¸²å½¢å¼çš„å›è°ƒå‡½æ•°å
                AndroidBridge.weChatLogin('handleWeChatLoginResult');
                
            } catch (e) {
                console.error('[å¾®ä¿¡ç™»å½•] å¼‚å¸¸:', e);
                addLog('âŒ è°ƒç”¨å¤±è´¥: ' + e.message);
                showResult(false, 'è°ƒç”¨å¼‚å¸¸', e.message);
            }
        }
        
        // å¤„ç†å¾®ä¿¡ç™»å½•ç»“æœï¼ˆç”±Androidå›è°ƒï¼‰
        function handleWeChatLoginResult(result) {
            console.log('[å¾®ä¿¡ç™»å½•] æ”¶åˆ°å›è°ƒ:', result);
            
            if (result.error) {
                // ç™»å½•å¤±è´¥
                onWeChatLoginError(result);
            } else if (result.code) {
                // ç™»å½•æˆåŠŸ
                onWeChatLoginSuccess(result);
            } else {
                // æœªçŸ¥å“åº”
                addLog('âš ï¸ æ”¶åˆ°æœªçŸ¥å“åº”');
                showResult(false, 'æœªçŸ¥å“åº”', JSON.stringify(result, null, 2));
            }
        }
        
        // è·å–å¾®ä¿¡ç”¨æˆ·ä¿¡æ¯
        async function getUserInfo() {
            if (!wechatCode) {
                alert('è¯·å…ˆè¿›è¡Œå¾®ä¿¡ç™»å½•è·å–code');
                return;
            }
            
            addLog('ğŸ”„ å¼€å§‹è·å–å¾®ä¿¡ç”¨æˆ·ä¿¡æ¯...');
            addLog('ğŸ“¤ è°ƒç”¨æœåŠ¡å™¨API');
            
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                showResult(true, 'æ­£åœ¨è·å–ç”¨æˆ·ä¿¡æ¯...', 'è¯·ç¨å€™...');
                
                // è°ƒç”¨æœåŠ¡å™¨API
                const response = await fetch('https://oauth.qsgl.net/api/Wechat/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        code: wechatCode
                    })
                });
                
                addLog(`ğŸ“¥ æœåŠ¡å™¨å“åº”: ${response.status} ${response.statusText}`);
                
                if (!response.ok) {
                    // å¤„ç†é”™è¯¯å“åº”
                    const errorText = await response.text();
                    addLog(`âŒ è¯·æ±‚å¤±è´¥: ${errorText}`);
                    
                    let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMessage = errorJson.detail || errorJson.title || errorMessage;
                    } catch (e) {
                        errorMessage = errorText || errorMessage;
                    }
                    
                    showResult(false, 'è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥', errorMessage);
                    return;
                }
                
                // è§£ææˆåŠŸå“åº”
                const userData = await response.json();
                console.log('[ç”¨æˆ·ä¿¡æ¯]:', userData);
                addLog('âœ… æˆåŠŸè·å–ç”¨æˆ·ä¿¡æ¯');
                
                // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
                const userInfoHtml = `å¾®ä¿¡ç”¨æˆ·ä¿¡æ¯ï¼š

UnionID: ${userData.unionid || 'æœªè·å–'}
OpenID: ${userData.openid || 'æœªè·å–'}
æ˜µç§°: ${userData.nickname || 'æœªè®¾ç½®'}
æ€§åˆ«: ${userData.sex === 1 ? 'ç”·' : userData.sex === 2 ? 'å¥³' : 'æœªçŸ¥'}
å›½å®¶: ${userData.country || 'æœªçŸ¥'}
çœä»½: ${userData.province || 'æœªçŸ¥'}
åŸå¸‚: ${userData.city || 'æœªçŸ¥'}
å¤´åƒURL: ${userData.headImgUrl || 'æ— '}

å®Œæ•´æ•°æ®:
${JSON.stringify(userData, null, 2)}`;
                
                showResult(true, 'âœ… å¾®ä¿¡ç”¨æˆ·ä¿¡æ¯è·å–æˆåŠŸ', userInfoHtml);
                
                // å¦‚æœæœ‰å¤´åƒï¼Œå¯ä»¥æ˜¾ç¤º
                if (userData.headImgUrl) {
                    addLog('ğŸ‘¤ ç”¨æˆ·å¤´åƒ: ' + userData.headImgUrl);
                }
                
            } catch (error) {
                console.error('[è·å–ç”¨æˆ·ä¿¡æ¯] å¼‚å¸¸:', error);
                addLog('âŒ è·å–ç”¨æˆ·ä¿¡æ¯å¼‚å¸¸: ' + error.message);
                showResult(false, 'è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥', `é”™è¯¯: ${error.message}\n\nè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒæœåŠ¡å™¨çŠ¶æ€`);
            }
        }
        
        // å¾®ä¿¡æ”¯ä»˜åŠŸèƒ½
        // ğŸ”§ å¼€å‘æµ‹è¯•å¼€å…³ï¼štrue=ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼Œfalse=è°ƒç”¨çœŸå®API
        const USE_MOCK_PAYMENT_DATA = false; // âœ… åˆ‡æ¢åˆ°çœŸå®API
        
        async function startWeChatPay() {
            addLog('ğŸ’° å¼€å§‹å¾®ä¿¡æ”¯ä»˜æµ‹è¯•...');
            
            try {
                // æ£€æŸ¥AndroidBridgeæ˜¯å¦å­˜åœ¨
                if (typeof AndroidBridge === 'undefined') {
                    addLog('âŒ AndroidBridgeä¸å­˜åœ¨ï¼ˆå¯èƒ½ä¸åœ¨APPä¸­ï¼‰');
                    showResult(false, 'AndroidBridgeä¸å­˜åœ¨', 
                        'æ­¤åŠŸèƒ½ä»…åœ¨365é…’æ°´APPä¸­å¯ç”¨ã€‚\nè¯·åœ¨APPçš„WebViewä¸­æ‰“å¼€æ­¤é¡µé¢ã€‚');
                    return;
                }
                
                // ç”Ÿæˆè®¢å•å·
                const orderNo = 'TEST' + Date.now();
                const amount = '0.01';
                const goodsName = '365é…’æ°´æµ‹è¯•å•†å“';
                
                addLog(`ğŸ“ è®¢å•å·: ${orderNo}`);
                addLog(`ğŸ’µ é‡‘é¢: ${amount}å…ƒ`);
                
                // ğŸ”§ ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®è¿›è¡Œæµ‹è¯•ï¼ˆç»•è¿‡æœåŠ¡å™¨SSLé—®é¢˜ï¼‰
                if (USE_MOCK_PAYMENT_DATA) {
                    addLog('âš ï¸ ä½¿ç”¨æ¨¡æ‹Ÿæ”¯ä»˜æ•°æ®ï¼ˆå¼€å‘æµ‹è¯•æ¨¡å¼ï¼‰');
                    showResult(true, 'ç”Ÿæˆæ¨¡æ‹Ÿæ”¯ä»˜å‚æ•°...', 'ä»…ç”¨äºæµ‹è¯•Androidç«¯åŠŸèƒ½');
                    
                    // æ¨¡æ‹ŸAPIå»¶è¿Ÿ
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    const mockPaymentData = {
                        appId: "wx19d89333ff0d3efe",
                        timeStamp: String(Math.floor(Date.now() / 1000)),
                        nonceStr: "mock_nonce_" + Math.random().toString(36).substring(2, 15),
                        package: "prepay_id=mock_prepay_" + Date.now(),
                        signType: "MD5",
                        paySign: "MOCK" + Math.random().toString(36).substring(2, 15).toUpperCase(),
                        orderNo: orderNo,
                        trxId: "MOCK_TRX_" + Date.now(),
                        isSuccess: true,
                        amount: "1", // 1åˆ†
                        goodsDescription: goodsName
                    };
                    
                    console.log('[ğŸ§ª æ¨¡æ‹Ÿæ”¯ä»˜å‚æ•°]:', mockPaymentData);
                    addLog('âœ… æ¨¡æ‹Ÿæ”¯ä»˜å‚æ•°ç”ŸæˆæˆåŠŸ');
                    
                    const paramsInfo = `appId: ${mockPaymentData.appId}
timeStamp: ${mockPaymentData.timeStamp}
nonceStr: ${mockPaymentData.nonceStr}
package: ${mockPaymentData.package}
signType: ${mockPaymentData.signType}
paySign: ${mockPaymentData.paySign}
orderNo: ${mockPaymentData.orderNo}
amount: ${mockPaymentData.amount}åˆ†

ğŸ§ª è¿™æ˜¯æ¨¡æ‹Ÿæ•°æ®ï¼Œç”¨äºæµ‹è¯•Androidç«¯å¾®ä¿¡SDKè°ƒç”¨
å®Œæ•´å“åº”:
${JSON.stringify(mockPaymentData, null, 2)}`;
                    
                    showResult(true, 'âœ… æ¨¡æ‹Ÿæ”¯ä»˜å‚æ•°è·å–æˆåŠŸ', paramsInfo);
                    
                    // è°ƒç”¨Androidç«¯å¾®ä¿¡æ”¯ä»˜
                    addLog('ğŸ“² è°ƒç”¨Androidç«¯å¾®ä¿¡æ”¯ä»˜...');
                    AndroidBridge.launchWeChatPay(JSON.stringify(mockPaymentData));
                    addLog('âœ… å·²å‘é€æ”¯ä»˜è¯·æ±‚åˆ°å¾®ä¿¡');
                    
                    return;
                }
                
                // ========== ä»¥ä¸‹æ˜¯çœŸå®APIè°ƒç”¨ä»£ç  ==========
                addLog('ğŸ“¤ å‡†å¤‡è°ƒç”¨æ”¯ä»˜æ¥å£...');
                
                const merchantId = '103881636900016'; // å•†æˆ·ID
                const notifyUrl = 'https://payment.qsgl.net/api/payment/notify'; // æ”¯ä»˜å›è°ƒåœ°å€
                                addLog(`ğŸ’µ é‡‘é¢: ${amount}å…ƒ`);
                addLog(`ğŸ“¦ å•†å“: ${goodsName}`);
                
                // è°ƒç”¨æ”¯ä»˜æ¥å£
                showResult(true, 'æ­£åœ¨åˆ›å»ºæ”¯ä»˜è®¢å•...', 'è¯·ç¨å€™...');
                
                const response = await fetch('https://payment.qsgl.net/api/payment/wechat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        OrderNo: orderNo,
                        OrderAmount: amount,  // å­—ç¬¦ä¸²ç±»å‹
                        MerchantId: merchantId,
                        GoodsName: goodsName,
                        NotifyUrl: notifyUrl
                    })
                });
                
                addLog(`ğŸ“¥ æ”¯ä»˜æ¥å£å“åº”: ${response.status}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    addLog(`âŒ æ”¯ä»˜æ¥å£è°ƒç”¨å¤±è´¥: ${errorText}`);
                    showResult(false, 'åˆ›å»ºæ”¯ä»˜è®¢å•å¤±è´¥', `HTTP ${response.status}: ${errorText}`);
                    return;
                }
                
                const paymentData = await response.json();
                console.log('[æ”¯ä»˜å‚æ•°]:', paymentData);
                addLog('âœ… æ”¯ä»˜è®¢å•åˆ›å»ºæˆåŠŸ');
                
                // æ£€æŸ¥è¿”å›æ•°æ®
                if (!paymentData.isSuccess) {
                    addLog(`âŒ æ”¯ä»˜è®¢å•åˆ›å»ºå¤±è´¥: ${paymentData.errorMessage}`);
                    showResult(false, 'åˆ›å»ºæ”¯ä»˜è®¢å•å¤±è´¥', paymentData.errorMessage || 'æœªçŸ¥é”™è¯¯');
                    return;
                }
                
                // æ˜¾ç¤ºæ”¯ä»˜å‚æ•°
                const paramsInfo = `appId: ${paymentData.appId}
timeStamp: ${paymentData.timeStamp}
nonceStr: ${paymentData.nonceStr}
package: ${paymentData.package}
signType: ${paymentData.signType}
paySign: ${paymentData.paySign}
orderNo: ${paymentData.orderNo}
amount: ${paymentData.amount}åˆ†

å®Œæ•´å“åº”:
${JSON.stringify(paymentData, null, 2)}`;
                
                showResult(true, 'âœ… æ”¯ä»˜å‚æ•°è·å–æˆåŠŸ', paramsInfo);
                addLog('ğŸ“± å‡†å¤‡è°ƒèµ·å¾®ä¿¡æ”¯ä»˜...');
                
                // æ£€æŸ¥åŸç”Ÿæ”¯ä»˜æ–¹æ³•
                if (typeof AndroidBridge.launchWeChatPay !== 'function') {
                    addLog('âŒ AndroidBridge.launchWeChatPay æ–¹æ³•ä¸å­˜åœ¨');
                    showResult(false, 'æ–¹æ³•ä¸å­˜åœ¨', 
                        'AndroidBridge.launchWeChatPay æ–¹æ³•ä¸å­˜åœ¨ã€‚\nè¯·ç¡®ä¿APPå·²æ­£ç¡®å®ç°å¾®ä¿¡æ”¯ä»˜åŠŸèƒ½ã€‚');
                    return;
                }
                
                // è°ƒç”¨åŸç”Ÿæ–¹æ³•è°ƒèµ·å¾®ä¿¡æ”¯ä»˜
                addLog('ğŸš€ è°ƒç”¨ AndroidBridge.launchWeChatPay()');
                AndroidBridge.launchWeChatPay(JSON.stringify(paymentData));
                addLog('â³ ç­‰å¾…å¾®ä¿¡æ”¯ä»˜ç»“æœ...');
                
            } catch (error) {
                console.error('[å¾®ä¿¡æ”¯ä»˜] å¼‚å¸¸:', error);
                addLog('âŒ å¾®ä¿¡æ”¯ä»˜å¼‚å¸¸: ' + error.message);
                showResult(false, 'å¾®ä¿¡æ”¯ä»˜å¤±è´¥', `é”™è¯¯: ${error.message}\n\n${error.stack || ''}`);
            }
        }
        
        // å¾®ä¿¡æ”¯ä»˜ç»“æœå›è°ƒï¼ˆç”±Androidè°ƒç”¨ï¼‰
        function handleWeChatPayResult(result) {
            console.log('[å¾®ä¿¡æ”¯ä»˜] æ”¶åˆ°å›è°ƒ:', result);
            
            if (result.success) {
                addLog('âœ… å¾®ä¿¡æ”¯ä»˜æˆåŠŸ');
                showResult(true, 'âœ… æ”¯ä»˜æˆåŠŸ', `è®¢å•å·: ${result.orderNo || 'æœªçŸ¥'}\n\n${JSON.stringify(result, null, 2)}`);
            } else {
                const errorMsg = result.errorMessage || result.message || 'æœªçŸ¥é”™è¯¯';
                addLog('âŒ å¾®ä¿¡æ”¯ä»˜å¤±è´¥: ' + errorMsg);
                
                let title = 'æ”¯ä»˜å¤±è´¥';
                if (result.errorCode === 'CANCEL' || errorMsg.includes('å–æ¶ˆ')) {
                    title = 'ç”¨æˆ·å–æ¶ˆæ”¯ä»˜';
                }
                
                showResult(false, title, `${errorMsg}\n\n${JSON.stringify(result, null, 2)}`);
            }
        }
        
        // æ‹‰èµ·å¾®ä¿¡å°ç¨‹åº
        async function launchMiniProgram() {
            console.log('[å¾®ä¿¡å°ç¨‹åº] å¼€å§‹æ‹‰èµ·å°ç¨‹åº');
            addLog('ğŸš€ å‡†å¤‡æ‹‰èµ·å¾®ä¿¡å°ç¨‹åº');
            
            try {
                // æ£€æŸ¥ AndroidBridge æ˜¯å¦å­˜åœ¨
                if (typeof AndroidBridge === 'undefined') {
                    throw new Error('AndroidBridge æœªå®šä¹‰ï¼Œè¯·åœ¨APPä¸­æ‰“å¼€');
                }
                
                if (typeof AndroidBridge.launchWeChatMiniProgram !== 'function') {
                    throw new Error('launchWeChatMiniProgram æ–¹æ³•ä¸å­˜åœ¨');
                }
                
                // å°ç¨‹åºé…ç½®
                const miniProgramConfig = {
                    userName: "gh_41188c5f7176",  // å°ç¨‹åºåŸå§‹ID âœ… å·²ç¡®è®¤
                    path: "",  // é¡µé¢è·¯å¾„,ä¸ºç©ºåˆ™æ‰“å¼€é¦–é¡µ
                    miniprogramType: 0  // 0-æ­£å¼ç‰ˆ, 1-å¼€å‘ç‰ˆ, 2-ä½“éªŒç‰ˆ
                };
                
                addLog('ğŸ“ å°ç¨‹åºé…ç½®:');
                addLog(`  åŸå§‹ID: ${miniProgramConfig.userName}`);
                addLog(`  é¡µé¢è·¯å¾„: ${miniProgramConfig.path || 'é¦–é¡µ'}`);
                addLog(`  ç‰ˆæœ¬ç±»å‹: ${miniProgramConfig.miniprogramType === 0 ? 'æ­£å¼ç‰ˆ' : miniProgramConfig.miniprogramType === 1 ? 'å¼€å‘ç‰ˆ' : 'ä½“éªŒç‰ˆ'}`);
                
                // è°ƒç”¨åŸç”Ÿæ–¹æ³•æ‹‰èµ·å°ç¨‹åº
                addLog('ğŸš€ è°ƒç”¨ AndroidBridge.launchWeChatMiniProgram()');
                AndroidBridge.launchWeChatMiniProgram(JSON.stringify(miniProgramConfig));
                addLog('â³ ç­‰å¾…å¾®ä¿¡å°ç¨‹åºå“åº”...');
                
            } catch (error) {
                console.error('[å¾®ä¿¡å°ç¨‹åº] å¼‚å¸¸:', error);
                addLog('âŒ æ‹‰èµ·å°ç¨‹åºå¼‚å¸¸: ' + error.message);
                showResult(false, 'æ‹‰èµ·å°ç¨‹åºå¤±è´¥', `é”™è¯¯: ${error.message}\n\n${error.stack || ''}`);
            }
        }
        
        // å¾®ä¿¡å°ç¨‹åºç»“æœå›è°ƒï¼ˆç”±Androidè°ƒç”¨ï¼‰
        function handleMiniProgramResult(result) {
            console.log('[å¾®ä¿¡å°ç¨‹åº] æ”¶åˆ°å›è°ƒ:', result);
            
            if (result.success) {
                addLog('âœ… å°ç¨‹åºå·²å¯åŠ¨');
                showResult(true, 'âœ… å°ç¨‹åºå¯åŠ¨æˆåŠŸ', `${result.message || 'å°ç¨‹åºå·²æ‰“å¼€'}\n\n${JSON.stringify(result, null, 2)}`);
            } else {
                const errorMsg = result.errorMessage || result.message || 'æœªçŸ¥é”™è¯¯';
                addLog('âŒ æ‹‰èµ·å°ç¨‹åºå¤±è´¥: ' + errorMsg);
                showResult(false, 'æ‹‰èµ·å°ç¨‹åºå¤±è´¥', `${errorMsg}\n\n${JSON.stringify(result, null, 2)}`);
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆ
        window.onload = function() {
            addLog('ğŸ“„ é¡µé¢åŠ è½½å®Œæˆ');
            addLog('ğŸ” æ£€æµ‹è¿è¡Œç¯å¢ƒ...');
            
            if (typeof AndroidBridge !== 'undefined') {
                addLog('âœ… æ£€æµ‹åˆ° AndroidBridge');
                addLog('âœ… è¿è¡Œåœ¨365é…’æ°´APPä¸­');
                
                if (typeof AndroidBridge.weChatLogin === 'function') {
                    addLog('âœ… å¾®ä¿¡ç™»å½•åŠŸèƒ½å¯ç”¨');
                } else {
                    addLog('âš ï¸ å¾®ä¿¡ç™»å½•åŠŸèƒ½ä¸å¯ç”¨');
                }
                
                if (typeof AndroidBridge.launchWeChatPay === 'function') {
                    addLog('âœ… å¾®ä¿¡æ”¯ä»˜åŠŸèƒ½å¯ç”¨');
                } else {
                    addLog('âš ï¸ å¾®ä¿¡æ”¯ä»˜åŠŸèƒ½ä¸å¯ç”¨');
                }
                
                if (typeof AndroidBridge.launchWeChatMiniProgram === 'function') {
                    addLog('âœ… å¾®ä¿¡å°ç¨‹åºåŠŸèƒ½å¯ç”¨');
                } else {
                    addLog('âš ï¸ å¾®ä¿¡å°ç¨‹åºåŠŸèƒ½ä¸å¯ç”¨');
                }
                
                if (typeof AndroidBridge.requestAlipayPayment === 'function') {
                    addLog('âœ… æ”¯ä»˜å®æ”¯ä»˜åŠŸèƒ½å¯ç”¨');
                } else {
                    addLog('âš ï¸ æ”¯ä»˜å®æ”¯ä»˜åŠŸèƒ½ä¸å¯ç”¨');
                }
            } else {
                addLog('âš ï¸ æœªæ£€æµ‹åˆ° AndroidBridge');
                addLog('âš ï¸ è¯·åœ¨365é…’æ°´APPä¸­æ‰“å¼€');
            }
        };
        
        // ==================== æ”¯ä»˜å®æ”¯ä»˜åŠŸèƒ½ ====================
        
        /**
         * å‘èµ·æ”¯ä»˜å®æ”¯ä»˜
         */
        function startAlipayPayment() {
            console.log('[æ”¯ä»˜å®æ”¯ä»˜] å‡†å¤‡å‘èµ·æ”¯ä»˜');
            addLog('ğŸ’™ å‡†å¤‡å‘èµ·æ”¯ä»˜å®æ”¯ä»˜...');
            
            // æ£€æŸ¥ AndroidBridge
            if (typeof AndroidBridge === 'undefined' || typeof AndroidBridge.requestAlipayPayment !== 'function') {
                addLog('âŒ AndroidBridge.requestAlipayPayment æ–¹æ³•ä¸å­˜åœ¨');
                showResult(false, 'æ”¯ä»˜å®æ”¯ä»˜å¤±è´¥', 'AndroidBridge.requestAlipayPayment æ–¹æ³•ä¸å­˜åœ¨\n\nè¯·åœ¨365é…’æ°´APPä¸­æ‰“å¼€æ­¤é¡µé¢');
                return;
            }
            
            // ç”Ÿæˆè®¢å•å·
            const orderNo = 'ALIPAY' + new Date().getTime();
            
            // æ„å»ºæ”¯ä»˜å‚æ•°
            const paymentParams = {
                orderNo: orderNo,
                amount: 0.01,  // æµ‹è¯•é‡‘é¢ 1åˆ†é’±
                merchantId: '103881636900016',
                goodsName: 'æ”¯ä»˜å®æ”¯ä»˜æµ‹è¯•å•†å“',
                notifyUrl: 'https://payment.qsgl.net/api/payment/notify'
            };
            
            addLog('ğŸ“¦ æ”¯ä»˜å‚æ•°: ' + JSON.stringify(paymentParams));
            
            try {
                // è°ƒç”¨ Android JSBridge
                AndroidBridge.requestAlipayPayment(JSON.stringify(paymentParams));
                addLog('âœ… å·²è°ƒç”¨ AndroidBridge.requestAlipayPayment()');
            } catch (e) {
                console.error('[æ”¯ä»˜å®æ”¯ä»˜] è°ƒç”¨å¤±è´¥:', e);
                addLog('âŒ è°ƒç”¨ AndroidBridge.requestAlipayPayment() å¤±è´¥: ' + e.message);
                showResult(false, 'æ”¯ä»˜å®æ”¯ä»˜å¤±è´¥', 'Error: ' + e.message);
            }
        }
        
        /**
         * æ”¯ä»˜å®æ”¯ä»˜ç»“æœå›è°ƒ
         * ç”± Android ç«¯è°ƒç”¨
         */
        function handleAlipayPaymentResult(result) {
            console.log('[æ”¯ä»˜å®æ”¯ä»˜] æ”¶åˆ°æ”¯ä»˜ç»“æœ:', result);
            addLog('ğŸ“ æ”¶åˆ°æ”¯ä»˜å®æ”¯ä»˜ç»“æœå›è°ƒ');
            
            if (result.success) {
                addLog('âœ… æ”¯ä»˜å®æ”¯ä»˜æˆåŠŸ');
                showResult(true, 'âœ… æ”¯ä»˜å®æ”¯ä»˜æˆåŠŸ', `è®¢å•å·: ${result.orderNo}\n${result.message || 'æ”¯ä»˜æˆåŠŸ'}\n\nå®Œæ•´å“åº”:\n${JSON.stringify(result, null, 2)}`);
            } else {
                const errorMsg = result.errorMessage || result.message || 'æ”¯ä»˜å¤±è´¥';
                const errorCode = result.errorCode || 'UNKNOWN';
                
                addLog(`âŒ æ”¯ä»˜å®æ”¯ä»˜å¤±è´¥: ${errorMsg}`);
                
                let errorDesc = '';
                switch (errorCode) {
                    case 'USER_CANCEL':
                        errorDesc = 'æ‚¨å–æ¶ˆäº†æ”¯ä»˜';
                        break;
                    case 'NETWORK_ERROR':
                        errorDesc = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•';
                        break;
                    case 'PAY_FAILED':
                        errorDesc = 'æ”¯ä»˜å¤±è´¥ï¼Œè¯·é‡è¯•';
                        break;
                    case 'PROCESSING':
                        errorDesc = 'æ”¯ä»˜ç»“æœç¡®è®¤ä¸­ï¼Œè¯·ç¨åæŸ¥è¯¢è®¢å•çŠ¶æ€';
                        break;
                    case 'PARAM_ERROR':
                        errorDesc = 'æ”¯ä»˜å‚æ•°é”™è¯¯';
                        break;
                    case 'API_ERROR':
                        errorDesc = 'æ”¯ä»˜æ¥å£è°ƒç”¨å¤±è´¥';
                        break;
                    default:
                        errorDesc = errorMsg;
                }
                
                showResult(false, 'æ”¯ä»˜å®æ”¯ä»˜å¤±è´¥', `é”™è¯¯ä»£ç : ${errorCode}\né”™è¯¯æè¿°: ${errorDesc}\n\nå®Œæ•´å“åº”:\n${JSON.stringify(result, null, 2)}`);
            }
        }
    </script>
</body>
</html>

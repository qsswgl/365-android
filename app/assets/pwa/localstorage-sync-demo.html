<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LocalStorage åŒæ­¥ç¤ºä¾‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 20px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 24px;
        }
        
        .section {
            margin-bottom: 30px;
            border-bottom: 1px solid #eee;
            padding-bottom: 20px;
        }
        
        .section:last-child {
            border-bottom: none;
        }
        
        h2 {
            color: #555;
            font-size: 16px;
            margin-bottom: 12px;
        }
        
        .form-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        input[type="text"] {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.1);
        }
        
        button {
            padding: 10px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #45a049;
        }
        
        button:active {
            transform: scale(0.98);
        }
        
        button.danger {
            background: #f44336;
        }
        
        button.danger:hover {
            background: #da190b;
        }
        
        button.info {
            background: #2196F3;
        }
        
        button.info:hover {
            background: #0b7dda;
        }
        
        .status {
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .list {
            background: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 4px;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .list-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            font-size: 13px;
            word-break: break-all;
        }
        
        .list-item:last-child {
            border-bottom: none;
        }
        
        .list-item-key {
            color: #4CAF50;
            font-weight: bold;
        }
        
        .list-item-value {
            color: #666;
        }
        
        .list-empty {
            padding: 20px;
            text-align: center;
            color: #999;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .debug-log {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #333;
            line-height: 1.5;
        }
        
        .log-entry {
            margin-bottom: 4px;
        }
        
        .log-time {
            color: #999;
        }
        
        .log-info {
            color: #2196F3;
        }
        
        .log-success {
            color: #4CAF50;
        }
        
        .log-error {
            color: #f44336;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“± LocalStorage åŒæ­¥ç¤ºä¾‹</h1>
        
        <!-- çŠ¶æ€ä¿¡æ¯ -->
        <div class="section">
            <h2>å½“å‰çŠ¶æ€</h2>
            <div id="statusDiv" class="status info">æ­£åœ¨åˆå§‹åŒ–...</div>
            <p style="font-size: 12px; color: #666; margin-top: 8px;">
                <strong>é¦–æ¬¡å¯åŠ¨ï¼š</strong>SQLite ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤æ•°æ®åˆå§‹åŒ–<br>
                <strong>éé¦–æ¬¡å¯åŠ¨ï¼š</strong>ä» SQLite æ¢å¤ä¿å­˜çš„æ•°æ®
            </p>
        </div>
        
        <!-- æ·»åŠ æ•°æ® -->
        <div class="section">
            <h2>æ·»åŠ æ•°æ®åˆ° LocalStorage</h2>
            <div class="form-group">
                <input type="text" id="keyInput" placeholder="è¾“å…¥é”®(key)" value="userName">
                <input type="text" id="valueInput" placeholder="è¾“å…¥å€¼(value)" value="å¼ ä¸‰">
                <button onclick="addToLocalStorage()">ä¿å­˜</button>
            </div>
        </div>
        
        <!-- æŸ¥çœ‹æ•°æ® -->
        <div class="section">
            <h2>LocalStorage ä¸­çš„æ•°æ®</h2>
            <div class="button-group">
                <button class="info" onclick="refreshLocalStorageList()">åˆ·æ–°åˆ—è¡¨</button>
                <button class="danger" onclick="clearLocalStorage()">æ¸…ç©ºæ‰€æœ‰</button>
            </div>
            <div id="localStorageList" class="list">
                <div class="list-empty">æ— æ•°æ®</div>
            </div>
        </div>
        
        <!-- SQLite æ•°æ®åº“æ“ä½œ -->
        <div class="section">
            <h2>SQLite æ•°æ®åº“æ“ä½œ</h2>
            <div class="button-group">
                <button class="info" onclick="checkDbStatus()">æ£€æŸ¥æ•°æ®åº“çŠ¶æ€</button>
                <button class="info" onclick="loadDataFromDb()">ä» SQLite è¯»å–æ•°æ®</button>
                <button class="info" onclick="saveDataToDb()">ä¿å­˜æ•°æ®åˆ° SQLite</button>
            </div>
            <div id="dbStatusDiv" style="margin-top: 10px;"></div>
        </div>
        
        <!-- è°ƒè¯•æ—¥å¿— -->
        <div class="section">
            <h2>è°ƒè¯•æ—¥å¿—</h2>
            <button class="danger" style="margin-bottom: 10px;" onclick="clearDebugLog()">æ¸…ç©ºæ—¥å¿—</button>
            <div id="debugLog" class="debug-log">
                <div class="log-entry"><span class="log-time">[ç³»ç»Ÿ]</span> <span class="log-info">æ—¥å¿—å‡†å¤‡å°±ç»ª</span></div>
            </div>
        </div>
    </div>
    
    <script>
        // ==================== æ—¥å¿—ç³»ç»Ÿ ====================
        class DebugLogger {
            constructor(elementId) {
                this.element = document.getElementById(elementId);
                this.maxLines = 100;
            }
            
            log(message, type = 'info') {
                const time = new Date().toLocaleTimeString('zh-CN');
                const classList = `log-entry log-${type}`;
                const entry = document.createElement('div');
                entry.className = classList;
                entry.innerHTML = `<span class="log-time">[${time}]</span> ${message}`;
                
                this.element.appendChild(entry);
                this.element.scrollTop = this.element.scrollHeight;
                
                // é™åˆ¶æ—¥å¿—è¡Œæ•°
                while (this.element.children.length > this.maxLines) {
                    this.element.removeChild(this.element.firstChild);
                }
            }
            
            info(message) { this.log(message, 'info'); }
            success(message) { this.log(message, 'success'); }
            error(message) { this.log(message, 'error'); }
            clear() { this.element.innerHTML = ''; }
        }
        
        const logger = new DebugLogger('debugLog');
        
        // ==================== åˆå§‹åŒ–ç³»ç»Ÿ ====================
        
        window.restoreLocalStorage = function(dbData) {
            logger.info('Android è°ƒç”¨: window.restoreLocalStorage()');
            logger.info('æ”¶åˆ°æ•°æ®åº“æ•°æ®: ' + JSON.stringify(dbData).substring(0, 100) + '...');
            
            // å°†æ•°æ®åº“æ•°æ®å†™å…¥ LocalStorage
            for (const [key, value] of Object.entries(dbData)) {
                localStorage.setItem(key, value);
                logger.info(`æ¢å¤æ•°æ®: ${key} = ${value.substring(0, 50)}...`);
            }
            
            logger.success('LocalStorage æ¢å¤å®Œæˆï¼Œå…± ' + Object.keys(dbData).length + ' æ¡è®°å½•');
            updateStatus('å·²ä» SQLite æ¢å¤æ•°æ®', 'success');
            refreshLocalStorageList();
            
            // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶
            if (window.onLocalStorageRestored) {
                window.onLocalStorageRestored(dbData);
            }
        };
        
        window.onFirstLaunch = function(launchType) {
            logger.info('Android è°ƒç”¨: window.onFirstLaunch("' + launchType + '")');
            logger.info('é¦–æ¬¡å¯åŠ¨åº”ç”¨ï¼Œåˆå§‹åŒ–é»˜è®¤æ•°æ®');
            
            // é¦–æ¬¡å¯åŠ¨çš„åˆå§‹åŒ–é€»è¾‘
            initializeDefaultData();
            
            updateStatus('é¦–æ¬¡å¯åŠ¨åº”ç”¨ï¼Œå·²åˆå§‹åŒ–é»˜è®¤æ•°æ®', 'success');
        };
        
        // åˆå§‹åŒ–é»˜è®¤æ•°æ®
        function initializeDefaultData() {
            const defaultData = {
                'appName': '365åº”ç”¨',
                'userName': 'ç”¨æˆ·',
                'userId': '',
                'theme': 'light',
                'language': 'zh-CN',
                'lastLogin': new Date().toISOString(),
                'settings': JSON.stringify({
                    notificationEnabled: true,
                    autoSave: true
                })
            };
            
            for (const [key, value] of Object.entries(defaultData)) {
                localStorage.setItem(key, value);
                logger.info(`åˆå§‹åŒ–: ${key} = ${value.substring(0, 50)}...`);
            }
            
            logger.success('é»˜è®¤æ•°æ®åˆå§‹åŒ–å®Œæˆ');
            refreshLocalStorageList();
        }
        
        // ==================== UI æ“ä½œ ====================
        
        function updateStatus(message, type) {
            const statusDiv = document.getElementById('statusDiv');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }
        
        function addToLocalStorage() {
            const key = document.getElementById('keyInput').value.trim();
            const value = document.getElementById('valueInput').value.trim();
            
            if (!key) {
                logger.error('é”®ä¸èƒ½ä¸ºç©º');
                return;
            }
            
            localStorage.setItem(key, value);
            logger.success(`å·²ä¿å­˜: ${key} = ${value}`);
            
            document.getElementById('keyInput').value = '';
            document.getElementById('valueInput').value = '';
            
            refreshLocalStorageList();
        }
        
        function refreshLocalStorageList() {
            const list = document.getElementById('localStorageList');
            
            if (localStorage.length === 0) {
                list.innerHTML = '<div class="list-empty">LocalStorage ä¸­æ— æ•°æ®</div>';
                return;
            }
            
            let html = '';
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                const displayValue = value.length > 100 ? value.substring(0, 100) + '...' : value;
                
                html += `
                    <div class="list-item">
                        <span class="list-item-key">${escapeHtml(key)}</span>: 
                        <span class="list-item-value">${escapeHtml(displayValue)}</span>
                        <button onclick="deleteLocalStorageItem('${key}')" style="margin-left: 10px; padding: 4px 8px; font-size: 12px;">åˆ é™¤</button>
                    </div>
                `;
            }
            
            list.innerHTML = html;
            logger.info(`LocalStorage ä¸­æœ‰ ${localStorage.length} æ¡è®°å½•`);
        }
        
        function deleteLocalStorageItem(key) {
            localStorage.removeItem(key);
            logger.info(`å·²åˆ é™¤: ${key}`);
            refreshLocalStorageList();
        }
        
        function clearLocalStorage() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ LocalStorage æ•°æ®å—ï¼Ÿ')) {
                localStorage.clear();
                logger.warn('å·²æ¸…ç©ºæ‰€æœ‰ LocalStorage æ•°æ®');
                refreshLocalStorageList();
            }
        }
        
        function checkDbStatus() {
            try {
                const count = AndroidBridge.getDbRecordCount();
                const statusHtml = `<div class="status info">æ•°æ®åº“ä¸­æœ‰ <strong>${count}</strong> æ¡è®°å½•</div>`;
                document.getElementById('dbStatusDiv').innerHTML = statusHtml;
                logger.info(`æ•°æ®åº“çŠ¶æ€: ${count} æ¡è®°å½•`);
            } catch (e) {
                logger.error('æ— æ³•è·å–æ•°æ®åº“çŠ¶æ€: ' + e.message);
            }
        }
        
        function loadDataFromDb() {
            try {
                const jsonData = AndroidBridge.getAllDataFromDb();
                const data = JSON.parse(jsonData);
                
                const recordCount = Object.keys(data).length;
                const statusHtml = `<div class="status success">ä»æ•°æ®åº“è¯»å–äº† <strong>${recordCount}</strong> æ¡è®°å½•</div>`;
                document.getElementById('dbStatusDiv').innerHTML = statusHtml;
                
                logger.success(`ä»æ•°æ®åº“è¯»å–äº† ${recordCount} æ¡è®°å½•`);
                for (const [key, value] of Object.entries(data)) {
                    logger.info(`${key} = ${value.substring(0, 50)}...`);
                }
            } catch (e) {
                logger.error('è¯»å–æ•°æ®åº“å¤±è´¥: ' + e.message);
                document.getElementById('dbStatusDiv').innerHTML = `<div class="status error">é”™è¯¯: ${e.message}</div>`;
            }
        }
        
        function saveDataToDb() {
            try {
                const allLocalStorage = {};
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    allLocalStorage[key] = localStorage.getItem(key);
                }
                
                AndroidBridge.saveAllLocalStorageToDb(JSON.stringify(allLocalStorage));
                
                const recordCount = Object.keys(allLocalStorage).length;
                const statusHtml = `<div class="status success">å·²ä¿å­˜ <strong>${recordCount}</strong> æ¡è®°å½•åˆ°æ•°æ®åº“</div>`;
                document.getElementById('dbStatusDiv').innerHTML = statusHtml;
                
                logger.success(`å·²ä¿å­˜ ${recordCount} æ¡è®°å½•åˆ°æ•°æ®åº“`);
            } catch (e) {
                logger.error('ä¿å­˜åˆ°æ•°æ®åº“å¤±è´¥: ' + e.message);
                document.getElementById('dbStatusDiv').innerHTML = `<div class="status error">é”™è¯¯: ${e.message}</div>`;
            }
        }
        
        function clearDebugLog() {
            logger.clear();
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ==================== é¡µé¢å¸è½½æ—¶ä¿å­˜æ•°æ® ====================
        
        window.addEventListener('beforeunload', function() {
            logger.info('é¡µé¢å¸è½½ï¼Œä¿å­˜ LocalStorage åˆ° SQLite');
            
            const allLocalStorage = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                allLocalStorage[key] = localStorage.getItem(key);
            }
            
            try {
                AndroidBridge.saveAllLocalStorageToDb(JSON.stringify(allLocalStorage));
                logger.success('æ•°æ®å·²ä¿å­˜');
            } catch (e) {
                logger.error('ä¿å­˜å¤±è´¥: ' + e.message);
            }
        });
        
        // åº”ç”¨è¿›å…¥åå°æ—¶ä¿å­˜
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                logger.info('åº”ç”¨è¿›å…¥åå°ï¼Œä¿å­˜æ•°æ®');
                
                const allLocalStorage = {};
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    allLocalStorage[key] = localStorage.getItem(key);
                }
                
                try {
                    AndroidBridge.saveAllLocalStorageToDb(JSON.stringify(allLocalStorage));
                    logger.success('åå°æ•°æ®å·²ä¿å­˜');
                } catch (e) {
                    logger.error('åå°ä¿å­˜å¤±è´¥: ' + e.message);
                }
            }
        });
        
        // ==================== é¡µé¢åŠ è½½å®Œæˆ ====================
        
        document.addEventListener('DOMContentLoaded', function() {
            logger.info('é¡µé¢åŠ è½½å®Œæˆ');
            
            // åˆ·æ–°åˆ—è¡¨
            refreshLocalStorageList();
            
            // æ£€æŸ¥æ•°æ®åº“çŠ¶æ€
            setTimeout(function() {
                checkDbStatus();
            }, 500);
        });
    </script>
</body>
</html>

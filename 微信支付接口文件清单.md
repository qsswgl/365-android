# 农行综合收银台 V4.0 微信支付接口文件清单

## 📋 文件清单概览

根据农行综合收银台接口包 V4.0（目录：`K:\365-android\综合收银台接口包_V4.0软件包`）搜索结果，以下是与微信支付相关的主要文件：

---

## 🔍 微信支付核心文件

### 1. **GetWeiXinAuthInfo.aspx** ⭐ 重要
**路径**：`综合收银台接口包_V4.0软件包/demo/GetWeiXinAuthInfo.aspx`

**功能**：获取微信人脸认证信息
- 生成支付请求对象：`com.abc.trustpay.client.ebus.GetWeiXinAuthInfo`
- 设置请求参数：
  - `StoreId`：门店ID
  - `StoreName`：门店名称
  - `DeviceId`：设备ID
  - `Attach`：附加参数
  - `RawData`：原始数据
  - `SubAppId`：子应用ID
  - `Now`：当前时间
  - `VersionNo`：版本号
  - `SignType`：签名类型
- 返回响应字段：
  - `ReturnCode`：返回码
  - `ErrorMessage`：错误信息
  - `AuthInfo`：认证信息
  - `ExpiresIn`：过期时间

**API调用方式**：
```csharp
com.abc.trustpay.client.ebus.GetWeiXinAuthInfo tMerchantInfo = 
    new com.abc.trustpay.client.ebus.GetWeiXinAuthInfo();
tMerchantInfo.merchantInfoRequest["StoreId"] = "value";
tMerchantInfo.postJSONRequest();
```

---

### 2. **MerchantPaymentUnified.aspx** ⭐⭐ 非常重要
**路径**：`综合收银台接口包_V4.0软件包/demo/MerchantPaymentUnified.aspx`

**标题**：农行网上支付平台-商户接口范例-微信支付请求

**功能**：统一支付请求（支持微信支付）

**核心类**：`com.abc.trustpay.client.ebus.UnifiedPaymentRequest`

**主要参数**：

#### 订单属性（dicOrder）
| 参数 | 说明 | 备注 |
|------|------|------|
| `TerminalNo` | 终端编号 | 必填 |
| `OrderNo` | 订单编号 | 必填 |
| `ExpiredDate` | 订单保存时间 | 可选 |
| `OrderAmount` | 交易金额 | 必填 |
| `SubsidyAmount` | 营销补贴金额 | 可选 |
| `Fee` | 手续费金额 | 可选 |
| `AccountNo` | 支付账户 | 微信APP支付时为授权码auth_code；公众号/小程序支付时必填 |
| `OpenID` | 用户在子商户appid下的唯一标识 | 公众号/小程序支付时必填 |
| `CurrencyCode` | 交易币种 | 默认人民币 |
| `OrderDate` | 订单日期 | 格式：YYYY/MM/DD |
| `OrderTime` | 订单时间 | 格式：HH:MM:SS |
| `PayTypeID` | 交易类型 | 可选值：公众号支付、小程序支付、APP支付、刷卡支付等 |

#### 支付请求属性（dicRequest）
| 参数 | 说明 | 备注 |
|------|------|------|
| `PaymentType` | 支付类型 | **8 = 微信支付** |
| `PaymentLinkType` | 支付接入方式 | 必填 |
| `MerchantRemarks` | 附言 | 可选 |
| `IsBreakAccount` | 是否支持向二级商户入账 | 可选 |
| `SplitAccTemplate` | 分账模版编号 | 可选 |
| `NotifyType` | 通知方式 | 可选 |

#### 微信对接字段映射
根据文件中的注释，以下字段对应微信接口：

| 农行字段 | 微信字段 | 说明 |
|---------|---------|------|
| `AccountNo` | `sub_appid` | 子商户APPID（公众号/小程序支付） |
| `AccountNo` | `auth_code` | 授权码（刷卡支付） |
| `OpenID` | `sub_openid` | 用户在子商户下的OpenID |
| `TrnxCode` | - | 支付方式代码，**8=微信支付** |
| `TrnxType` | 交易状态 | 对应微信对账单中的"交易状态"（SUCCESS、REFUND等） |

---

### 3. **MerchantPayCancel.aspx**
**路径**：`综合收银台接口包_V4.0软件包/demo/MerchantPayCancel.aspx`

**功能**：支付撤销/退款请求

**微信相关参数**：
| 参数 | 值 | 说明 |
|------|-----|------|
| `MerchantFlag` | `W` | 微信标识 |
| `MerchantFlag` | `Z` | 支付宝标识 |

**调用示例**：
```csharp
// 微信支付撤销
tPaymentRequest.dicRequest["MerchantFlag"] = "W";
```

---

### 4. **MerchantRealTimeRegister.aspx**
**路径**：`综合收银台接口包_V4.0软件包/demo/MerchantRealTimeRegister.aspx`

**功能**：实时结算注册

**微信相关字段**：

| 字段 | 对应微信字段 | 说明 |
|------|-------------|------|
| `TrnxCode` | - | 支付方式代码，**8=微信支付** |
| `TrnxType` | 交易状态 | 对应微信对账单中的"交易状态"<br/>如：SUCCESS、REFUND |
| `CustomId` | 用户标识 | 对应微信对账单中的"用户标识"<br/>如：otDNot6uuTOGLptNsyEB97uzRUQI |

---

### 5. **DownloadStatement.aspx**
**路径**：`综合收银台接口包_V4.0软件包/demo/DownloadStatement.aspx`

**功能**：对账单下载

**微信相关参数**：
| 参数值 | 说明 |
|--------|------|
| `WXALIPAY` | 微信支付宝对账单 |
| `W` | 微信对账单 |

---

### 6. **Merchant.html**
**路径**：`综合收银台接口包_V4.0软件包/demo/Merchant.html`

**功能**：商户菜单导航页面

**微信相关链接**：
```html
<a href='GetWeiXinAuthInfo.aspx'>获取微信人脸验证</a>
```

---

## 📚 相关目录结构

```
综合收银台接口包_V4.0软件包/
├── demo/                          # 演示代码目录
│   ├── GetWeiXinAuthInfo.aspx     ✅ 微信人脸认证
│   ├── MerchantPaymentUnified.aspx✅ 统一支付请求（主要）
│   ├── MerchantPayCancel.aspx     ✅ 支付撤销
│   ├── MerchantRealTimeRegister.aspx ✅ 实时结算
│   ├── DownloadStatement.aspx     ✅ 对账单下载
│   ├── Merchant.html              ✅ 菜单导航
│   └── [其他支付方式文件...]
├── cert/                          # 证书目录
└── Readme.txt                     # 说明文档
```

---

## 🔧 微信支付集成关键点

### 支付流程
```
1. 获取微信认证信息
   └─> GetWeiXinAuthInfo.aspx
       └─> 返回AuthInfo（用于后续支付）

2. 发起统一支付请求
   └─> MerchantPaymentUnified.aspx
       ├─> PaymentType = 8（微信支付）
       ├─> PayTypeID = 公众号/小程序/APP/刷卡支付
       └─> 返回支付页面或支付信息

3. 用户完成支付
   └─> 微信回调通知农行服务器

4. 查询订单状态
   └─> MerchantQueryOrder.aspx

5. 退款/撤销
   └─> MerchantPayCancel.aspx
```

### 支付类型代码
| 代码 | 说明 |
|------|------|
| `1` | POS支付 |
| `2` | BMP支付 |
| `3` | 现金支付 |
| `4` | 商户自有支付方式 |
| `5` | 网银转账 |
| `6` | 其他 |
| **`8`** | **微信支付** ⭐ |
| `9` | 支付宝支付 |

### 微信支付交易类型
| 类型 | 说明 |
|------|------|
| 公众号支付 | 微信公众号内支付 |
| 小程序支付 | 微信小程序内支付 |
| APP支付 | 第三方应用中调用微信支付 |
| 刷卡支付 | POS机等刷卡设备 |

---

## 📖 关键API调用示例

### 示例 1：微信支付请求
```csharp
// 创建支付请求对象
UnifiedPaymentRequest tPaymentRequest = new UnifiedPaymentRequest();

// 设置订单信息
tPaymentRequest.dicOrder["OrderNo"] = "20260107001";
tPaymentRequest.dicOrder["OrderAmount"] = "100.00";
tPaymentRequest.dicOrder["PayTypeID"] = "小程序支付";
tPaymentRequest.dicOrder["AccountNo"] = "wxxxxxxxxxxxxxxxxx"; // 小程序APPID
tPaymentRequest.dicOrder["OpenID"] = "oxxxxxxxxxxxxxxxx";     // 用户OpenID

// 设置支付请求参数
tPaymentRequest.dicRequest["PaymentType"] = "8";  // 8 = 微信支付
tPaymentRequest.dicRequest["PaymentLinkType"] = "WAP";

// 提交请求
tPaymentRequest.postRequest();
```

### 示例 2：获取微信认证信息
```csharp
GetWeiXinAuthInfo authInfo = new GetWeiXinAuthInfo();
authInfo.merchantInfoRequest["StoreId"] = "12345";
authInfo.merchantInfoRequest["SubAppId"] = "wxxxxxxxxxxxxxxxxx";
authInfo.postJSONRequest();

String AuthInfo = JSON.GetKeyValue("AuthInfo");
String ExpiresIn = JSON.GetKeyValue("ExpiresIn");
```

### 示例 3：支付撤销
```csharp
MerchantPayCancel cancelRequest = new MerchantPayCancel();
cancelRequest.dicRequest["OrigOrderNo"] = "20260107001";
cancelRequest.dicRequest["MerchantFlag"] = "W";  // W = 微信
cancelRequest.postRequest();
```

---

## 🎯 与应用的集成点

对于你的 Android 应用（365-android），微信支付集成应该：

1. **后端集成**（Java/C#）
   - 使用 `MerchantPaymentUnified` 类发起支付请求
   - 处理农行返回的支付信息或支付链接
   - 监听支付结果回调

2. **前端集成**（JavaScript/HTML5）
   - 调用后端支付接口
   - 获取支付参数（`prepay_id`、支付链接等）
   - 唤起微信支付（通过 Intent 或 URL Scheme）
   - 处理支付结果回调

3. **关键参数**
   - **PaymentType = "8"**（必须指定微信）
   - **AccountNo**（AppID 或授权码）
   - **OpenID**（用户标识，公众号/小程序支付时必填）

---

## 📝 文件对比表

| 文件名 | 功能 | 支付类型 | 优先级 |
|--------|------|---------|--------|
| GetWeiXinAuthInfo.aspx | 人脸认证 | 微信 | ⭐⭐⭐ |
| MerchantPaymentUnified.aspx | 统一支付 | 微信/支付宝 | ⭐⭐⭐⭐⭐ |
| MerchantPayCancel.aspx | 撤销/退款 | 微信/支付宝 | ⭐⭐⭐ |
| MerchantRealTimeRegister.aspx | 实时结算 | 微信/支付宝 | ⭐⭐ |
| DownloadStatement.aspx | 对账单下载 | 微信/支付宝 | ⭐⭐ |
| Merchant.html | 菜单导航 | - | ⭐ |

---

## ✅ 验证清单

- [x] 找到微信支付核心文件
- [x] 识别关键 API 类和方法
- [x] 提取微信相关参数
- [x] 建立参数映射关系
- [x] 提供集成示例代码
- [x] 标注优先级和用途

---

**文档生成时间**：2026-01-07  
**来源**：K:\365-android\综合收银台接口包_V4.0软件包  
**农行官方文档**：https://bank.u51.com/ebus-two/docs/#/
